<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">












  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=7.2.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.2.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.2.0" color="#222">






<link rel="stylesheet" href="/css/main.css?v=7.2.0">






<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">




  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-bounce.min.css?v=1.0.2">



  
  
  <link rel="stylesheet" href="/lib/fancybox/source/jquery.fancybox.css">



<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.2.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":true},
    copycode: {"enable":false,"show_result":false,"style":null},
    fancybox: true,
    mediumzoom: false,
    lazyload: true,
    pangu: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    }
  };
</script>

  <meta name="description" content="服务端代码踩了不少坑，其中在学习lua时还碰到坑爹的教程错误，而且skynet还没有api文档，初次看服务端源码时，会有些摸不着头脑，傻傻分不清哪部分属于skynet功能，哪部分属于自定义封装，有些时候不得不打开skynet源码查看，这时skynet的另一个优点就体现出来了，skynet核心源码并不多，要查起来也不会特别费时间，不过还是希望能有个详细的api文档，至少对初学者来说会方便不少，降低门">
<meta name="keywords" content="Lua,Skynet,游戏服务器">
<meta property="og:type" content="article">
<meta property="og:title" content="skynet范例研究-服务端">
<meta property="og:url" content="http://blog.tshine.me/skynet-sample-server.html">
<meta property="og:site_name" content="Tshine&#39;s blog">
<meta property="og:description" content="服务端代码踩了不少坑，其中在学习lua时还碰到坑爹的教程错误，而且skynet还没有api文档，初次看服务端源码时，会有些摸不着头脑，傻傻分不清哪部分属于skynet功能，哪部分属于自定义封装，有些时候不得不打开skynet源码查看，这时skynet的另一个优点就体现出来了，skynet核心源码并不多，要查起来也不会特别费时间，不过还是希望能有个详细的api文档，至少对初学者来说会方便不少，降低门">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-09-17T13:11:36.457Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="skynet范例研究-服务端">
<meta name="twitter:description" content="服务端代码踩了不少坑，其中在学习lua时还碰到坑爹的教程错误，而且skynet还没有api文档，初次看服务端源码时，会有些摸不着头脑，傻傻分不清哪部分属于skynet功能，哪部分属于自定义封装，有些时候不得不打开skynet源码查看，这时skynet的另一个优点就体现出来了，skynet核心源码并不多，要查起来也不会特别费时间，不过还是希望能有个详细的api文档，至少对初学者来说会方便不少，降低门">





  
  
  <link rel="canonical" href="http://blog.tshine.me/skynet-sample-server">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  
  <title>skynet范例研究-服务端 | Tshine's blog</title>
  






  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?f040c18a472a04e56ac5fd8c11506de8";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>







  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Tshine's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <h1 class="site-subtitle" itemprop="description">浪漫的人不会贫穷</h1>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-留言">

    
    
      
    

    

    <a href="/guestbook/" rel="section"><i class="menu-item-icon fa fa-fw fa-comment"></i> <br>留言</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.tshine.me/skynet-sample-server.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Tshine Zheng">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tshine's blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">skynet范例研究-服务端

              
            
          </h2>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-10-26 19:26:57" itemprop="dateCreated datePublished" datetime="2016-10-26T19:26:57+08:00">2016-10-26</time>
            </span>
          

          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Skynet/" itemprop="url" rel="index"><span itemprop="name">Skynet</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">评论数：</span>
                <a href="/skynet-sample-server.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/skynet-sample-server.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
            <span id="/skynet-sample-server.html" class="post-meta-item leancloud_visitors" data-flag-title="skynet范例研究-服务端">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              
                <span class="post-meta-item-text">阅读次数：</span>
              
                <span class="leancloud-visitors-count"></span>
            </span>
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>服务端代码踩了不少坑，其中在学习lua时还碰到坑爹的教程错误，而且skynet还没有api文档，初次看服务端源码时，会有些摸不着头脑，傻傻分不清哪部分属于skynet功能，哪部分属于自定义封装，有些时候不得不打开skynet源码查看，这时skynet的另一个优点就体现出来了，skynet核心源码并不多，要查起来也不会特别费时间，不过还是希望能有个详细的api文档，至少对初学者来说会方便不少，降低门槛。 </p>
<a id="more"></a>

<p>下面开始分析范例中的服务端代码。 范例github地址：</p>
<p><a href="https://github.com/cloudwu/skynet_sample" target="_blank" rel="noopener">https://github.com/cloudwu/skynet_sample</a> </p>
<p>源码分为3个文件夹，分别为service、lualib、src。<br>其中service主要是服务端<strong>业务逻辑</strong>，lualib为<strong>基础工具封装</strong>，src为<strong>c语言服务封装</strong>。 </p>
<p>一般阅读代码时先从main入手，跟着逻辑一步一步不断深入。</p>
<h1 id="main-lua"><a href="#main-lua" class="headerlink" title="main.lua"></a>main.lua</h1><p><em>文件路径：service/main.lua</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> skynet = <span class="built_in">require</span> <span class="string">"skynet"</span></span><br><span class="line">skynet.start(<span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    skynet.<span class="built_in">error</span>(<span class="string">"Server start"</span>)    <span class="comment">-- 打印Server start</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> skynet.<span class="built_in">getenv</span> <span class="string">"daemon"</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> console = skynet.newservice(<span class="string">"console"</span>)    <span class="comment">-- 创建控制台</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    skynet.newservice(<span class="string">"debug_console"</span>,<span class="number">8000</span>)             <span class="comment">-- 启动控制台服务</span></span><br><span class="line">    <span class="keyword">local</span> proto = skynet.uniqueservice <span class="string">"protoloader"</span>    <span class="comment">-- 启动封装的protoloader服务</span></span><br><span class="line">    skynet.call(proto, <span class="string">"lua"</span>, <span class="string">"load"</span>, &#123;                 <span class="comment">-- 调用protoloader服务的load接口</span></span><br><span class="line">        <span class="string">"proto.c2s"</span>,   <span class="comment">-- 客户端 to 服务器</span></span><br><span class="line">        <span class="string">"proto.s2c"</span>,   <span class="comment">-- 服务器 to 客户端</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">local</span> hub = skynet.uniqueservice <span class="string">"hub"</span>              <span class="comment">-- 启动hub服务</span></span><br><span class="line">    skynet.call(hub, <span class="string">"lua"</span>, <span class="string">"open"</span>, <span class="string">"0.0.0.0"</span>, <span class="number">5678</span>)    <span class="comment">-- 调用hub服务中的open接口，监听5678网络端口</span></span><br><span class="line">    skynet.<span class="built_in">exit</span>()</span><br><span class="line"><span class="keyword">end</span>)</span><br></pre></td></tr></table></figure>

<p>入口函数很简洁，首先启动了控制台服务，该服务使得skynet在运行时，可以打印log以及信息到终端界面。<br>protoloader服务为proto协议的封装，注意这里的protoloader为自定义封装，而不是skynet核心代码里自带的那个。<br>首先调用skynet.uniqueservice挂起了protoloader服务，所以接下来看看protoloader是怎么运行的。</p>
<h1 id="protoloader-lua"><a href="#protoloader-lua" class="headerlink" title="protoloader.lua"></a>protoloader.lua</h1><p><em>文件路径：service/protoloader.lua</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> skynet = <span class="built_in">require</span> <span class="string">"skynet"</span></span><br><span class="line"><span class="keyword">local</span> sprotoparser = <span class="built_in">require</span> <span class="string">"sprotoparser"</span> <span class="comment">--加载skynet/lualib下的sproto解析器</span></span><br><span class="line"><span class="keyword">local</span> sprotoloader = <span class="built_in">require</span> <span class="string">"sprotoloader"</span> <span class="comment">--sproto加器器</span></span><br><span class="line"><span class="keyword">local</span> service = <span class="built_in">require</span> <span class="string">"service"</span>           <span class="comment">--加载范例根目录lualib下的service</span></span><br><span class="line"><span class="keyword">local</span> <span class="built_in">log</span> = <span class="built_in">require</span> <span class="string">"log"</span>                   <span class="comment">--加载范例根目录lualib下的log</span></span><br><span class="line"><span class="keyword">local</span> loader = &#123;&#125;   <span class="comment">--保存函数</span></span><br><span class="line"><span class="keyword">local</span> data = &#123;&#125;     <span class="comment">--保存加载后的sproto协议在skynet sprotoparser里的序号，key值为文件名</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">load</span><span class="params">(name)</span></span></span><br><span class="line">    <span class="keyword">local</span> filename = <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"proto/%s.sproto"</span>, name)</span><br><span class="line">    <span class="keyword">local</span> f = <span class="built_in">assert</span>(<span class="built_in">io</span>.<span class="built_in">open</span>(filename), <span class="string">"Can't open "</span> .. name)</span><br><span class="line">    <span class="keyword">local</span> t = f:<span class="built_in">read</span> <span class="string">"a"</span></span><br><span class="line">    f:<span class="built_in">close</span>()                       <span class="comment">--以上为读取文件内容</span></span><br><span class="line">    <span class="keyword">return</span> sprotoparser.parse(t)    <span class="comment">--调用skynet的sprotoparser解析sproto协议</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loader.load</span><span class="params">(list)</span></span></span><br><span class="line">    <span class="keyword">for</span> i, name <span class="keyword">in</span> <span class="built_in">ipairs</span>(list) <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> p = <span class="built_in">load</span>(name)    <span class="comment">--加载sproto协议</span></span><br><span class="line">        <span class="built_in">log</span>(<span class="string">"load proto \[%s\] in slot %d"</span>, name, i)</span><br><span class="line">        data\[name\] = i</span><br><span class="line">        sprotoloader.save(p, i) <span class="comment">--保存解析后的sproto协议</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loader.index</span><span class="params">(name)</span></span></span><br><span class="line">    <span class="keyword">return</span> data\[name\]   <span class="comment">--返回sproto协议在skynet sprotoloader里序号</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 初始化服务的info信息和函数</span></span><br><span class="line">service.init &#123;</span><br><span class="line">    command = loader,</span><br><span class="line">    info = data</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要是定义了如何加载proto协议并保存，以及获取协议的编号(slot)，然后最后面调用了另一个lua文件的代码service.init方法。</p>
<h1 id="service-lua"><a href="#service-lua" class="headerlink" title="service.lua"></a>service.lua</h1><p><em>文件路径：lualib/service.lua</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> skynet = <span class="built_in">require</span> <span class="string">"skynet"</span></span><br><span class="line"><span class="keyword">local</span> <span class="built_in">log</span> = <span class="built_in">require</span> <span class="string">"log"</span></span><br><span class="line"><span class="keyword">local</span> service = &#123;&#125;</span><br><span class="line"><span class="comment">-- 初始化服务，主要功能为：1：注册服务info 2：注册服务的命令函数 3：启动服务</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">service.init</span><span class="params">(mod)</span></span></span><br><span class="line">    <span class="keyword">local</span> funcs = <span class="built_in">mod</span>.command</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">mod</span>.info <span class="keyword">then</span></span><br><span class="line">        skynet.info_func(<span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="comment">--</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">mod</span>.info</span><br><span class="line">        <span class="keyword">end</span>)</span><br><span class="line">        <span class="comment">-- 这里仅作调试用，当在调试模式下，输入 “info 服务ID” 就会打印上面返回的信息</span></span><br><span class="line">        <span class="comment">-- 调试模式的启动方法为 nc 127.0.0.1 8000</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    skynet.start(<span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">mod</span>.<span class="built_in">require</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> s = <span class="built_in">mod</span>.<span class="built_in">require</span></span><br><span class="line">            <span class="keyword">for</span> _, name <span class="keyword">in</span> <span class="built_in">ipairs</span>(s) <span class="keyword">do</span></span><br><span class="line">                service\[name\] = skynet.uniqueservice(name)  <span class="comment">--启动服务，并将该服务器保存在service下</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">mod</span>.init <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">mod</span>.init()</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        skynet.dispatch(<span class="string">"lua"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(_,_, cmd, ...)</span></span> <span class="comment">-- 修改lua协议的dispatch函数，对当前调用init的服务注册函数</span></span><br><span class="line">                                                        <span class="comment">-- skynet.dispatch函数也是服务启动的结束标示</span></span><br><span class="line">            <span class="keyword">local</span> f = funcs\[cmd\]    <span class="comment">--获取命令函数</span></span><br><span class="line">            <span class="keyword">if</span> f <span class="keyword">then</span></span><br><span class="line">                skynet.ret(skynet.pack(f(...))) <span class="comment">--返回命令调用结果，所有通过ret的返回值都要用pack打包</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">log</span>(<span class="string">"Unknown command : \[%s\]"</span>, cmd)</span><br><span class="line">                skynet.response()(<span class="literal">false</span>)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span>)</span><br><span class="line">    <span class="keyword">end</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--[[skynet.ret 在当前协程(为处理请求方消息而产生的协程)中给请求方(消息来源)的消息做回应</span></span><br><span class="line"><span class="comment">skynet.retpack 跟skynet.ret的区别是向请求方作回应时要用skynet.pack打包]]</span><span class="comment">--</span></span><br><span class="line"><span class="keyword">return</span> service</span><br></pre></td></tr></table></figure>

<p>该代码做的主要有3个工作，</p>
<ul>
<li>设定当前skynet服务debug info信息</li>
<li>设定当前skynet服务在接收到其他服务调用信息时的处理，比如上一段protoloader代码中的load函数和index函数。其他服务只要发送”函数名”或者“参数”，即可调用对应的函数。其中一个值得注意的点是，skynet中服务与服务的通信必须通过<strong>skynet.ret</strong>和<strong>skynet.retpack</strong>函数进行打包和封包处理。</li>
<li>加载其他服务，并保存在service这个table中。</li>
<li>往后所有服务的代码都会通过init函数处理info信息、注册函数、加载其他服务。</li>
</ul>
<p>回到main.lua中，紧接着调用了service.init中设定的load函数。然后挂起了hub服务。 <strong><em>为了不让文章变的太过冗长，下面会省略一些具体实现逻辑，主要以梳理流程为主，只有在关键点才会有详细的解释。</em></strong></p>
<h1 id="hub-lua"><a href="#hub-lua" class="headerlink" title="hub.lua"></a>hub.lua</h1><p><em>文件路径：service/hub.lua</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> skynet = <span class="built_in">require</span> <span class="string">"skynet"</span></span><br><span class="line"><span class="keyword">local</span> socket = <span class="built_in">require</span> <span class="string">"socket"</span></span><br><span class="line"><span class="keyword">local</span> proxy = <span class="built_in">require</span> <span class="string">"socket\_proxy"</span>    <span class="comment">--加载范例lualib目录下的socket\_proxy</span></span><br><span class="line"><span class="keyword">local</span> <span class="built_in">log</span> = <span class="built_in">require</span> <span class="string">"log"</span></span><br><span class="line"><span class="keyword">local</span> service = <span class="built_in">require</span> <span class="string">"service"</span></span><br><span class="line"><span class="keyword">local</span> hub = &#123;&#125;  <span class="comment">--保存函数</span></span><br><span class="line"><span class="keyword">local</span> data = &#123; socket = &#123;&#125; &#125;    <span class="comment">--保存监听到的链接</span></span><br><span class="line"><span class="comment">-- 调用auth服务</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">auth_socket</span><span class="params">(fd)</span></span></span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">assign_agent</span><span class="params">(fd, userid)</span></span></span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--所有监听到的新链接都会首先交给这个函数处理</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">new_socket</span><span class="params">(fd, addr)</span></span></span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--打开监听</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hub.open</span><span class="params">(ip, port)</span></span></span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--关闭监听</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hub.close</span><span class="params">()</span></span></span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--服务初始化，并挂起auth和manager服务</span></span><br><span class="line">service.init &#123;</span><br><span class="line">        ... </span><br><span class="line">    <span class="built_in">require</span> = &#123;</span><br><span class="line">        <span class="string">"auth"</span>,</span><br><span class="line">        <span class="string">"manager"</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到没有执行具体逻辑，主要以定义为主，并启动了两个服务，manager和auth。 在最开始local proxy = require “socket_proxy”中还启动了socket_proxyd服务。 不过在这边并有具体的逻辑执行，所以先不管，顺着流程继续看。</p>
<h1 id="监听网络端口"><a href="#监听网络端口" class="headerlink" title="监听网络端口"></a>监听网络端口</h1><p>回到main.lua，调用了hub服务中的open函数，开始监听网络端口。来看看该函数的具体实现。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hub.open</span><span class="params">(ip, port)</span></span></span><br><span class="line">    <span class="built_in">log</span>(<span class="string">"Listen %s:%d"</span>, ip, port)</span><br><span class="line">    <span class="built_in">assert</span>(data.fd == <span class="literal">nil</span>, <span class="string">"Already open"</span>)  <span class="comment">--判断监听是否打开</span></span><br><span class="line">    data.fd = socket.listen(ip, port)       <span class="comment">--新建监听端口</span></span><br><span class="line">    data.ip = ip</span><br><span class="line">    data.port = port</span><br><span class="line">    socket.start(data.fd, new\_socket)       <span class="comment">--开始监听，将监听到的链接返回到new\_socket函数</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>这时如果客户端发起请求，就会将监听到的链接交给new_socket函数处理</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">new_socket</span><span class="params">(fd, addr)</span></span></span><br><span class="line">    data.socket\[fd\] = <span class="string">"\[AUTH\]"</span></span><br><span class="line">    proxy.subscribe(fd) <span class="comment">--将新链接提交给socketproxy</span></span><br><span class="line">    <span class="keyword">local</span> ok , userid =  <span class="built_in">pcall</span>(auth_socket, fd)</span><br><span class="line">    <span class="keyword">if</span> ok <span class="keyword">then</span></span><br><span class="line">        data.socket\[fd\] = userid</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">pcall</span>(assign_agent, fd, userid) <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span>  <span class="comment">-- succ</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            ...</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">```lua</span><br><span class="line">首先调用了socket_proxy.lua中的subscribe函数 </span><br><span class="line"></span><br><span class="line">_文件路径：lualib/socket_proxy.lua_</span><br><span class="line"></span><br><span class="line">```lua</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">proxy.subscribe</span><span class="params">(fd)</span></span></span><br><span class="line">    <span class="keyword">local</span> addr = map\[fd\]</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> addr <span class="keyword">then</span></span><br><span class="line">        addr = skynet.call(proxyd, <span class="string">"lua"</span>, fd)   <span class="comment">--向proxyd 发送命令，创建基于fd链接的服务，详见socket_proxyd.lua</span></span><br><span class="line">        map\[fd\] = addr  <span class="comment">--保存服务地址</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>向proxyd服务发送链接对象<br><em>文件路径：service/socket_proxyd.lua</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">subscribe</span><span class="params">(fd)</span></span></span><br><span class="line">    <span class="keyword">local</span> addr = socket\_fd\_addr\[fd\]</span><br><span class="line">    <span class="keyword">if</span> addr <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> addr     <span class="comment">--如果连接已经保存则直接返回服务ID</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    addr = <span class="built_in">assert</span>(skynet.launch(<span class="string">"package"</span>, skynet.self(), fd))  <span class="comment">--创建c语言服务package（连接代理），跑当前服务(self()返回当前服务ID)，返回的是c服务的地址</span></span><br><span class="line">    socket\_fd\_addr\[fd\] = addr   <span class="comment">--保存c服务的地址，key值为链接</span></span><br><span class="line">    socket\_addr\_fd\[addr\] = fd   <span class="comment">--保存链接，key值为c服务的地址</span></span><br><span class="line">    socket_init\[addr\] = skynet.response()   <span class="comment">--保存该链接的response函数，回应函数，这里同时会回应之前call过来的服务，告诉他addr</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>这里创建了一个c语言编写的package服务，不必关心具体实现，只要知道它的功能主要是让当前链接成为一个单独的skynet服务即可，返回值是该服务的ID。 最后通过skynet.response函数返回服务ID给调用前的函数，也就是socket_proxy的subscribe。</p>
<h1 id="处理链接数据"><a href="#处理链接数据" class="headerlink" title="处理链接数据"></a>处理链接数据</h1><p>一路回到hub.lua的new_socket函数。又将链接提交给auth_socket函数</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">auth_socket</span><span class="params">(fd)</span></span></span><br><span class="line">    <span class="keyword">return</span> (skynet.call(service.auth, <span class="string">"lua"</span>, <span class="string">"shakehand"</span> , fd))</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>通过service.call启动service中保存的auth服务，调用其中的shakehand函数，并发送fd链接对象。<br><em>文件路径：service/auth.lua</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">auth.shakehand</span><span class="params">(fd)</span></span></span><br><span class="line">    <span class="keyword">local</span> c = client.dispatch &#123; fd = fd &#125;   <span class="comment">--将链接交给client对信息进行处理</span></span><br><span class="line">    <span class="keyword">return</span> c.userid</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>这里可以理解为和客户端一第次“握手”，调用client的dispatch函数，并发送链接。 </p>
<p><em>文件路径：lualib/client.lua</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--消息处理</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">client.dispatch</span><span class="params">( c )</span></span></span><br><span class="line">    <span class="keyword">local</span> fd = c.fd</span><br><span class="line">    proxy.subscribe(fd)</span><br><span class="line">    <span class="keyword">local</span> ERROR = &#123;&#125;</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> msg, sz = proxy.<span class="built_in">read</span>(fd)  <span class="comment">--读取连接发来的数据</span></span><br><span class="line">        <span class="keyword">local</span> <span class="built_in">type</span>, name, args, response = host:dispatch(msg, sz)   <span class="comment">--sproto解析数据</span></span><br><span class="line">        <span class="built_in">assert</span>(<span class="built_in">type</span> == <span class="string">"REQUEST"</span>)   <span class="comment">--此处保证连接数据为请求</span></span><br><span class="line">        <span class="keyword">if</span> c.<span class="built_in">exit</span> <span class="keyword">then</span>  <span class="comment">--exit参数为退出循环标志</span></span><br><span class="line">            <span class="keyword">return</span> c</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">local</span> f = handler\[name\]     <span class="comment">--通过sproto解析出来的数据，获取回调函数</span></span><br><span class="line">        <span class="keyword">if</span> f <span class="keyword">then</span></span><br><span class="line">            <span class="comment">-- f may block , so fork and run</span></span><br><span class="line">            <span class="comment">-- 此处创建一个协程运行回调函数</span></span><br><span class="line">            skynet.fork(<span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">                <span class="keyword">local</span> ok, result = <span class="built_in">pcall</span>(f, c, args)    <span class="comment">-- 回调函数具体详见agent，auth，回调函数在那边实现</span></span><br><span class="line">                                                        <span class="comment">-- 此处回调函数都为显式传参，将c显式传到回调函数中</span></span><br><span class="line">                <span class="keyword">if</span> ok <span class="keyword">then</span></span><br><span class="line">                    proxy.<span class="built_in">write</span>(fd, response(result))   <span class="comment">-- 使用sproto解析出来的response函数包装返回值，并发送数据</span></span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="built_in">log</span>(<span class="string">"raise error = %s"</span>, result)</span><br><span class="line">                    proxy.<span class="built_in">write</span>(fd, response(ERROR, result))</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span>)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">-- unsupported command, disconnected</span></span><br><span class="line">            <span class="built_in">error</span> (<span class="string">"Invalid command "</span> .. name)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>这个函数为消息处理最关键的函数，所有请求都通过这里进行分发，其中回调函数都保存在handler这个table中，当前范例的回调函数都在agent.lua和，auth.lua中定义。 通过代码可以看到，该函数是一个死循环，也就是说，会不断的读取客户端发送过来的信息进行处理。只有当exit变量为ture时才退出，这个exit怎么来的先不管。 接下来通过客户端发送的请求流程继续梳理。</p>
<h1 id="网络请求流程"><a href="#网络请求流程" class="headerlink" title="网络请求流程"></a>网络请求流程</h1><p>回顾下客户端的消息流程： 首先会发送signin请求，发现sign失败，用户不存在，继续发送signup请求注册用户，注册成功后再次发送signin请求，登入成功，接着会发送login请求，后面的就是正常的业务请求了。请求顺序如下： signin &gt; signup &gt; signin &gt; login &gt; other 一步一步来，首先是signin，回到上面的dispatch，通过请求信息调用名为signin回调函数。signin的回调实现在auth.lua中<br><em>文件路径：service/auth.lua</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- signin登入请求回调</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cli:signin</span><span class="params">(args)</span></span></span><br><span class="line">    <span class="built_in">log</span>(<span class="string">"signin userid = %s"</span>, args.userid)</span><br><span class="line">    <span class="keyword">if</span> users\[args.userid\] <span class="keyword">then</span></span><br><span class="line">        self.userid = args.userid   <span class="comment">--self为修改隐式参数</span></span><br><span class="line">        self.<span class="built_in">exit</span> = <span class="literal">true</span>    <span class="comment">--退出client中dispatch循环，表示登入成功，退出auth服务，进入下一个服务</span></span><br><span class="line">        <span class="keyword">return</span> SUCC</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> FAIL</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>可以看到，当客户端第一次请求signin时，是返回失败FAIL的。这时又会回到client的dispatch函数，返回客户端注册失败消息后，继续读取链接信息。 当客户端接到signin失败后，会紧接着发送signup请求。 同样来到auth.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- signup注册账号请求回调</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cli:signup</span><span class="params">(args)</span></span></span><br><span class="line">    <span class="built_in">log</span>(<span class="string">"signup userid = %s"</span>, args.userid)</span><br><span class="line">    <span class="keyword">if</span> users\[args.userid\] <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> FAIL</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        users\[args.userid\] = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">return</span> SUCC</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>这时就回返回成功，回到dispath发送注册成功消息。 接下来客户端再次发送sigin请求就会signin成功。 要注意的是，在signin回调函数中，如果signin成功则会修改exit变量，这会导致退出client的dispatch循环。为什么这里能修改exit变量呢，原因是所有回调函数都是<strong>隐式传参</strong>的，在函数定义中使用了“<strong>冒号</strong>”，表示隐式传送<strong>self参数</strong>。在dispatch中可以看到调用回调时，都会传进c变量。pcall(f, c, args) 登入成功后就会退出dispatch的循环，那么跟踪代码退到hub中的new_socket方法，发现又调用了assign_agent函数。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">assign_agent</span><span class="params">(fd, userid)</span></span></span><br><span class="line">    skynet.call(service.manager, <span class="string">"lua"</span>, <span class="string">"assign"</span>, fd, userid)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>assign_gent则调用了service中保存的manager服务，同时调用manage服务中的assign方法，并传入链接对象和登入成功返回的userid。<br><em>文件路径：service/manager.lua</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">manager.assign</span><span class="params">(fd, userid)</span></span></span><br><span class="line">    <span class="keyword">local</span> agent</span><br><span class="line">    <span class="keyword">repeat</span></span><br><span class="line">        agent = users\[userid\]   <span class="comment">--判断是否有当前用户的服务</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> agent <span class="keyword">then</span>       <span class="comment">--若没有则创建一个</span></span><br><span class="line">            agent = new_agent()</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> users\[userid\] <span class="keyword">then</span></span><br><span class="line">                <span class="comment">-- double check</span></span><br><span class="line">                users\[userid\] = agent</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                free_agent(agent)</span><br><span class="line">                agent = users\[userid\]</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">until</span> skynet.call(agent, <span class="string">"lua"</span>, <span class="string">"assign"</span>, fd, userid)   <span class="comment">--此处返回ture，跳出循环</span></span><br><span class="line">    <span class="built_in">log</span>(<span class="string">"Assign %d to %s \[%s\]"</span>, fd, userid, agent)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>顺着流程走，由于客户端第一次登入，会调用new_agent方法。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">new_agent</span><span class="params">()</span></span></span><br><span class="line">    <span class="comment">-- todo: use a pool</span></span><br><span class="line">    <span class="keyword">return</span> skynet.newservice <span class="string">"agent"</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>这里会为每个用户启动一个agent服务。 接着until中会调用该agent服务的assign方法。<br><em>文件路径：service/agent.lua</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">agent.assign</span><span class="params">(fd, userid)</span></span></span><br><span class="line">        ... </span><br><span class="line">    skynet.fork(new_user, fd)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>做了很简单一件事，调用了new_user这个方法，这里要注意的是，使用了skynet.fork方法调用，该方法的作用是，不会阻塞线程，为什么要这么做接着往后看。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">new_user</span><span class="params">(fd)</span></span></span><br><span class="line">    <span class="keyword">local</span> ok, <span class="built_in">error</span> = <span class="built_in">pcall</span>(client.dispatch , &#123; fd = fd &#125;)  <span class="comment">--进入客户端消息循环，若此处客户端长时间没有任何操作，而报超时错误返回</span></span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>可以看到，这里调用了client中的dispatch，前面知道该函数是个死循环，这就是为什么之前使用了skynet.fork的原因了。 好了，这样就又进入消息处理循环了，之前客户端已经发送了signin，signup，signin，这三个请求，接下来会发送login请求，去到login请求回调。该回调定义在agent.lua中。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cli:login</span><span class="params">()</span></span></span><br><span class="line">    <span class="built_in">assert</span>(<span class="keyword">not</span> self.login)</span><br><span class="line">    <span class="keyword">if</span> data.fd <span class="keyword">then</span> <span class="comment">--重复登入</span></span><br><span class="line">        <span class="built_in">log</span>(<span class="string">"login fail %s fd=%d"</span>, data.userid, self.fd)</span><br><span class="line">        <span class="keyword">return</span> &#123; ok = <span class="literal">false</span> &#125;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    data.fd = self.fd</span><br><span class="line">    self.login = <span class="literal">true</span></span><br><span class="line">    <span class="built_in">log</span>(<span class="string">"login succ %s fd=%d"</span>, data.userid, self.fd)</span><br><span class="line">    client.push(self, <span class="string">"push"</span>, &#123; text = <span class="string">"welcome"</span> &#125;) <span class="comment">-- push message to client</span></span><br><span class="line">    <span class="keyword">return</span> &#123; ok = <span class="literal">true</span> &#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>主要就是调用client.push函数发送welcome信息，再来看看client中push函数的实现</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">client.push</span><span class="params">(c, t, data)</span></span></span><br><span class="line">    proxy.<span class="built_in">write</span>(c.fd, sender(t, data))</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>调用socket_proxy中的write</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">proxy.write</span><span class="params">(fd, msg, sz)</span></span></span><br><span class="line">    skynet.send(get_addr(fd), <span class="string">"client"</span>, msg, sz)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>这里用到了skynet.send函数，第一参数是服务地址，就是之前创建的package服务。 以上就是范例中服务端代码的主要逻辑。</p>
<p>另外我对服务端代码进行了大部分注释。<br>链接: <a href="http://pan.baidu.com/s/1dFKD2oh" target="_blank" rel="noopener">http://pan.baidu.com/s/1dFKD2oh</a> 密码: rfc9</p>
<h1 id="扩展阅读"><a href="#扩展阅读" class="headerlink" title="扩展阅读"></a>扩展阅读</h1><blockquote>
<p>[skynet 的一个简单范例-云风的BLOG]<br>(<a href="http://blog.codingnow.com/2016/06/skynet_sample.html" target="_blank" rel="noopener">http://blog.codingnow.com/2016/06/skynet_sample.html</a>)<br><a href="https://github.com/cloudwu/skynet/wiki/LuaAPI" target="_blank" rel="noopener">skynet LuaAPI</a><br><a href="http://www.mamicode.com/info-detail-891453.html" target="_blank" rel="noopener">skynet API参考</a><br><a href="https://github.com/cloudwu/skynet" target="_blank" rel="noopener">skynet github 项目</a></p>
</blockquote>

      
    </div>

    

    
      
    

    
    
    

    

    
      
    
    
      <div>
        <div id="reward-container">
  <div></div>
  <button id="reward-button" disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">

    
      
      
        
      
      <div style="display: inline-block">
        <img src="/images/wechatpay.png" alt="Tshine Zheng 微信支付">
        <p>微信支付</p>
      </div>
    
      
      
        
      
      <div style="display: inline-block">
        <img src="/images/alipay.png" alt="Tshine Zheng 支付宝">
        <p>支付宝</p>
      </div>
    

  </div>
</div>

      </div>
    

    
      <div>
        




  



<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Tshine Zheng</li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    
    <a href="http://blog.tshine.me/skynet-sample-server.html" title="skynet范例研究-服务端">http://blog.tshine.me/skynet-sample-server.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        
          
        
        <div class="post-tags">
          
            <a href="/tags/Lua/" rel="tag"># Lua</a>
          
            <a href="/tags/Skynet/" rel="tag"># Skynet</a>
          
            <a href="/tags/游戏服务器/" rel="tag"># 游戏服务器</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/seafile-auto-start-failed.html" rel="next" title="Seafile开机启动失败的解决办法">
                <i class="fa fa-chevron-left"></i> Seafile开机启动失败的解决办法
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/cocos2dx-lua-development-environment-setup.html" rel="prev" title="Cocos2dx Lua开发环境搭建">
                Cocos2dx Lua开发环境搭建 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">

          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  
  <p class="site-author-name" itemprop="name">Tshine Zheng</p>
  <div class="site-description motion-element" itemprop="description"></div>
</div>


  <nav class="site-state motion-element">
    
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">34</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
    

    
      
      
      <div class="site-state-item site-state-categories">
        
          
            <a href="/categories/">
          
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">分类</span>
        </a>
      </div>
    

    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/tags/">
          
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">31</span>
        <span class="site-state-item-name">标签</span>
        </a>
      </div>
    
  </nav>







  <div class="links-of-author motion-element">
    
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="https://github.com/TshineZheng" title="GitHub &rarr; https://github.com/TshineZheng" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
    
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="mailto:gtshine@gmail.com" title="E-Mail &rarr; mailto:gtshine@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
    
  </div>







          
          
        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#main-lua"><span class="nav-number">1.</span> <span class="nav-text">main.lua</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#protoloader-lua"><span class="nav-number">2.</span> <span class="nav-text">protoloader.lua</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#service-lua"><span class="nav-number">3.</span> <span class="nav-text">service.lua</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#hub-lua"><span class="nav-number">4.</span> <span class="nav-text">hub.lua</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#监听网络端口"><span class="nav-number">5.</span> <span class="nav-text">监听网络端口</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#处理链接数据"><span class="nav-number">6.</span> <span class="nav-text">处理链接数据</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#网络请求流程"><span class="nav-number">7.</span> <span class="nav-text">网络请求流程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#扩展阅读"><span class="nav-number">8.</span> <span class="nav-text">扩展阅读</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2011 – <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Tshine Zheng</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.2.0</div>



  <div class="footer-custom">Hosted by <a target="_blank" rel="external nofollow" href="https://pages.coding.me"><b>Coding Pages</b></a></div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    

  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>






  





  







  
  









  
  <script src="/lib/jquery/index.js?v=3.4.1"></script>

  
  <script src="/lib/fancybox/source/jquery.fancybox.pack.js"></script>

  
  <script src="/lib/lazyload/lozad.min.js?v=1.10.0"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>




  <script src="/js/utils.js?v=7.2.0"></script>

  <script src="/js/motion.js?v=7.2.0"></script>



  
  


  <script src="/js/affix.js?v=7.2.0"></script>

  <script src="/js/schemes/pisces.js?v=7.2.0"></script>




  
  <script src="/js/scrollspy.js?v=7.2.0"></script>
<script src="/js/post-details.js?v=7.2.0"></script>



  <script src="/js/next-boot.js?v=7.2.0"></script>

  

  

  


  




  
  
  <script src="/lib/bookmark/bookmark.min.js?v=1.0"></script>
  <script>
  
    bookmark.scrollToMark('manual', "#更多");
  
  </script>





  

<script src="//unpkg.com/valine/dist/Valine.min.js"></script>

<script>
  var GUEST = ['nick', 'mail', 'link'];
  var guest = 'nick,mail,link';
  guest = guest.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#comments',
    verify: true,
    notify: false,
    appId: 'Tp4HMrirjYpUVRmeqoCIXrPh-gzGzoHsz',
    appKey: 'dV4EzUxh77uKd0q1sCYaVMTR',
    placeholder: 'ヾﾉ≧∀≦)o来啊，快活啊!',
    avatar: 'mm',
    meta: guest,
    pageSize: '10' || 10,
    visitor: true,
    lang: '' || 'zh-cn'
  });
</script>




  





















<script>
// GET RESPONSIVE HEIGHT PASSED FROM IFRAME

window.addEventListener("message", function(e) {
  var data = e.data;
  if ((typeof data === 'string') && (data.indexOf('ciu_embed') > -1)) {
    var featureID = data.split(':')[1];
    var height = data.split(':')[2];
    $(`iframe[data-feature=${featureID}]`).height(parseInt(height) + 30);
  }
}, false);
</script>








  

</body>
</html>
